<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prisonniers_dilemma_g2_10</a> &gt; <a href="index.source.html" class="el_package">fr.uga.m1miage.pc.controller</a> &gt; <span class="el_source">GameController.java</span></div><h1>GameController.java</h1><pre class="source lang-java linenums">package fr.uga.m1miage.pc.controller;

import fr.uga.m1miage.pc.model.ChoiceMessage;
import fr.uga.m1miage.pc.model.GameSession;
import fr.uga.m1miage.pc.model.Invitation;
import fr.uga.m1miage.pc.model.InvitationAnswer;
import fr.uga.m1miage.pc.model.Player;
import fr.uga.m1miage.pc.model.Result;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.handler.annotation.*;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;

import java.util.LinkedHashMap;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;

@Controller
<span class="fc" id="L21">public class GameController {</span>

 @Autowired
 private SimpMessagingTemplate messagingTemplate;

<span class="fc" id="L26"> Map&lt;String, Integer&gt; invitationIterationMap = new LinkedHashMap&lt;&gt;();</span>
 // Map to hold active game sessions
<span class="fc" id="L28"> static final ConcurrentMap&lt;String, GameSession&gt; activeGames = new ConcurrentHashMap&lt;&gt;();</span>

 @MessageMapping(&quot;/invite&quot;)
 public void invitePlayer(@Payload Invitation invitation) {
<span class="fc" id="L32">	 invitationIterationMap.put(invitation.getFromPlayer() + &quot;&amp;&quot; + invitation.getToUsername(), invitation.getIteration());</span>
     // Send the message to the user
<span class="fc" id="L34">	messagingTemplate.convertAndSendToUser(invitation.getToUsername(), &quot;/queue/invitation&quot;,invitation.getFromPlayer());</span>
<span class="fc" id="L35"> }</span>
 
 @MessageMapping(&quot;/invitationAnswer&quot;)
 public void playerResponseToInvitation(@Payload InvitationAnswer answer) {
<span class="fc" id="L39">	 messagingTemplate.convertAndSend(&quot;/queue/gameStartHandler&quot;, answer.getMessage());</span>
<span class="fc bfc" id="L40" title="All 2 branches covered.">	 if (answer.getMessage().equals(&quot;confirmed&quot;))</span>
<span class="fc" id="L41">		 pairingPlayers(answer.getPlayerUsername(), answer.getOponentUsername());</span>
<span class="fc" id="L42"> }</span>

 void pairingPlayers(String player1Username, String player2Username) {
<span class="fc" id="L45">     Player player1 = WebSocketController.connectedPlayers.get(player1Username);</span>
<span class="fc" id="L46">     Player player2 = WebSocketController.connectedPlayers.get(player2Username);</span>
<span class="fc" id="L47">     GameSession session = new GameSession(player1, player2);</span>
<span class="fc" id="L48">     String key = player1.getUsername() + &quot;&amp;&quot; + player2.getUsername();</span>
<span class="fc bfc" id="L49" title="All 2 branches covered.">     if (!invitationIterationMap.containsKey(key))</span>
<span class="fc" id="L50">    	 key = player2.getUsername() + &quot;&amp;&quot; + player1.getUsername();</span>
<span class="fc" id="L51">     session.setTotalIterations(invitationIterationMap.get(key));</span>
<span class="fc" id="L52">     String gameId = player1.getUsername() + &quot;VS&quot; + player2.getUsername();</span>
<span class="fc" id="L53">     activeGames.put(gameId, session);</span>
<span class="fc" id="L54"> }</span>

 @MessageMapping(&quot;/makeChoice&quot;)
 public void makeChoice(@Payload ChoiceMessage choiceMessage) {
     // Find the game session for this player
<span class="fc" id="L59">     GameSession session = findGameSession(choiceMessage.getUsername());</span>
     
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">     if (session == null) {</span>
<span class="nc" id="L62">    	 return; </span>
     }
<span class="fc bfc" id="L64" title="All 2 branches covered.">     if (session.getPlayer1().getUsername().equals(choiceMessage.getUsername()))</span>
<span class="fc" id="L65">     	session.getPlayer1Choices().add(choiceMessage.getChoice());</span>
	else
<span class="fc" id="L67"> 		session.getPlayer2Choices().add(choiceMessage.getChoice());</span>
<span class="pc bpc" id="L68" title="1 of 4 branches missed.">     if (session.getPlayer1Choices().size() == session.getPlayer2Choices().size() &amp;&amp; session.getPlayer1Choices().size() == session.getCurrentIteration() + 1) {</span>
<span class="fc" id="L69">    	 session.incrementIteration();</span>
<span class="fc" id="L70">    	 computeScores(session);</span>
     }
<span class="fc" id="L72"> }</span>

 public GameSession findGameSession(String username) {
<span class="fc" id="L75">     GameSession result = null;</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">	 for (Map.Entry&lt;String, GameSession&gt; entry : activeGames.entrySet()) {</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">    	 if (entry.getKey().contains(username)) {</span>
<span class="fc" id="L78">    		 result = entry.getValue(); </span>
    	 }
<span class="fc" id="L80">     }</span>
<span class="fc" id="L81">     return result;</span>
 }

 void computeScores(GameSession session) {
<span class="fc" id="L85">     String choice1 = session.getPlayer1Choices().get(session.getPlayer1Choices().size() - 1);</span>
<span class="fc" id="L86">     String choice2 = session.getPlayer2Choices().get(session.getPlayer2Choices().size() - 1);</span>

<span class="fc" id="L88">     int score1 = 0;</span>
<span class="fc" id="L89">     int score2 = 0;</span>

<span class="fc bfc" id="L91" title="All 4 branches covered.">     if (choice1.equals(&quot;c&quot;) &amp;&amp; choice2.equals(&quot;c&quot;)) {</span>
<span class="fc" id="L92">         score1 = 3;</span>
<span class="fc" id="L93">         score2 = 3;</span>
<span class="pc bpc" id="L94" title="1 of 4 branches missed.">     } else if (choice1.equals(&quot;c&quot;) &amp;&amp; choice2.equals(&quot;t&quot;)) {</span>
<span class="fc" id="L95">         score2 = 5;</span>
<span class="pc bpc" id="L96" title="2 of 4 branches missed.">     } else if (choice1.equals(&quot;t&quot;) &amp;&amp; choice2.equals(&quot;c&quot;)) {</span>
<span class="fc" id="L97">         score1 = 5;</span>
<span class="nc bnc" id="L98" title="All 4 branches missed.">     } else if (choice1.equals(&quot;t&quot;) &amp;&amp; choice2.equals(&quot;t&quot;)) {</span>
<span class="nc" id="L99">         score1 = 1;</span>
<span class="nc" id="L100">         score2 = 1;</span>
     }

<span class="fc" id="L103">     session.getPlayer1().setScore(session.getPlayer1().getScore() + score1);</span>
<span class="fc" id="L104">     session.getPlayer2().setScore(session.getPlayer2().getScore() + score2);</span>
     
<span class="fc bfc" id="L106" title="All 2 branches covered.">     if (session.getCurrentIteration() == session.getTotalIterations()) {</span>
<span class="fc" id="L107">         endGame(session);</span>
     } else {
<span class="fc" id="L109">    	 Result result = new Result();</span>
<span class="fc" id="L110">    	 result.setScore(session.getPlayer1().getUsername() + &quot;(&quot; + session.getPlayer1().getScore() + &quot;) - &quot; + session.getPlayer2().getUsername() + &quot;(&quot; + session.getPlayer2().getScore() + &quot;)&quot;);</span>
<span class="fc" id="L111">    	 result.setStatus(&quot;En cours&quot;);</span>
<span class="fc" id="L112">    	 result.setParti((session.getCurrentIteration() + 1) + &quot;/&quot; + session.getTotalIterations());</span>
    	// Send updated scores to both players
<span class="fc" id="L114">         messagingTemplate.convertAndSend(&quot;/queue/scoreUpdate&quot;, result.toJson()); </span>
     }
<span class="fc" id="L116"> }</span>

 void endGame(GameSession session) {
<span class="fc" id="L119">	 Result result = new Result();</span>
<span class="fc" id="L120">	 result.setScore(session.getPlayer1().getUsername() + &quot;(&quot; + session.getPlayer1().getScore() + &quot;) - &quot; + session.getPlayer2().getUsername() + &quot;(&quot; + session.getPlayer2().getScore() + &quot;)&quot;);</span>
<span class="fc" id="L121">	 result.setStatus(&quot;Termin√©&quot;);</span>
<span class="fc" id="L122">	 result.setParti(session.getTotalIterations() + &quot;/&quot; + session.getTotalIterations());</span>
	// Send updated scores to both players
<span class="fc" id="L124">     messagingTemplate.convertAndSend(&quot;/queue/gameEnd&quot;, result.toJson());</span>

     // Remove the game session
<span class="fc" id="L127">     activeGames.values().removeIf(s -&gt; s.equals(session));</span>
<span class="fc" id="L128"> }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>