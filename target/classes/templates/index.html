<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dilemne du prisonnier</title>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
</head>
<body>
    <h1>Dilemne du prisonnier</h1>

    <div id="login">
        <input type="text" id="username" placeholder="Enter your username" />
        <button id="connectButton">Se connecter</button>
    </div>

    <div id="waiting" style="display:none;">
        <p id="playersHeader">Aucun utilisateur connecté, veuillez attendre</p>
        <ul id="availablePlayers"></ul>
    </div>

    <div id="game" style="display:none;">
        <p>Match débuté!</p>
        <p>Parti: <span id="roundNumber">0</span></p>
        <p>Votre Score: <span id="yourScore">0</span> | Score adversaire: <span id="opponentScore">0</span></p>
        <div id="choices">
            <button onclick="makeChoice('c')">Coopérer</button>
            <button onclick="makeChoice('t')">Trahir</button>
        </div>
    </div>

    <div id="endGame" style="display:none;">
        <h2>Match terminé!</h2>
        <p>Score final : Toi <span id="finalYourScore">0</span> - Adversaire <span id="finalOpponentScore">0</span></p>
    </div>

    <script>
        class Player {
            constructor(username, sessionId) {
                this.username = username;
                this.sessionId = sessionId;
            }
        }

        var stompClient = null;
        var gameId = null;
        var username = '';
        var oponentUsername = '';
        var sessionId = ''; // Track the session ID
        var totalIterations = 0;
        var currentRound = 0;

        function isValidUsername(username) {
            const regex = /^[a-zA-Z0-9]{3,16}$/;
            return regex.test(username);
        }

        // Connect function to handle user connection
        function connect() {
            // Get the username input
            username = document.getElementById('username').value;

            // Check if username is empty
            if (username === '' || !isValidUsername(username)) {
                alert('Veuillez entrer un nom d\'utilisateur correct.\nSans espace, sans caractère spécial.');
                return;
            }

            // Establish the WebSocket connection using SockJS
            var socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                // Get the session ID from the WebSocket connection headers if available
                try {
                    sessionId = /\/([^\/]+)\/websocket/.exec(socket._transport.url)[1];
                } catch (e) {
                    console.log("Failed to extract session ID", e);
                }

                // Subscribe to available players topic
                stompClient.subscribe('/topic/availablePlayers', function (message) {
                    updateAvailablePlayers(JSON.parse(message.body));
                });
                
                // Subscribe to invitations topic
                stompClient.subscribe(`/user/${username}/queue/invitation`, function (message) {
                    // Handle invitation message
                    handleInvitation(message.body);
                });

                // Send a connection message with the username and sessionId
                stompClient.send("/app/connectUser", {}, JSON.stringify({username: username, sessionId: sessionId}));

                // Hide login and show the waiting area
                document.getElementById('login').style.display = 'none';
                document.getElementById('waiting').style.display = 'block';
            }, function (error) {
                console.log("Error connecting:", error);
            });
        }       

        function handleInvitation(inviterUsername) {
            opponentUsername = inviterUsername;
            // Display a notification to the user
            let confirmed = confirm(`${opponentUsername} vous invite à jouer, voulez-vous accepter l'invitation ?`);
            if (confirmed) {
                console.log(`Current value opponent: ${inviterUsername}`);
                stompClient.send("/app/invitationAnswer", {}, JSON.stringify({message : "confirmed", oponentUsername : inviterUsername}));
            }
            else
                stompClient.send("/app/invitationAnswer", {}, JSON.stringify({message : "declined", oponentUsername : inviterUsername}));

        }

        // Start the game for both players when they receive the game start message
        function startGameForBothPlayers(message) {
            // Hide the waiting div and show the game div
            document.getElementById('waiting').style.display = 'none';
            document.getElementById('game').style.display = 'block';

            // Reset the round number and scores
            document.getElementById('roundNumber').textContent = '1';  // Start from round 1
            document.getElementById('yourScore').textContent = '0';
            document.getElementById('opponentScore').textContent = '0';
        }

        function makeChoice(choice) {
            // Send the choice to the backend via WebSocket
            if (stompClient && gameId) {
                stompClient.send("/app/makeChoice", {}, JSON.stringify({
                    gameId: gameId,
                    username: username,
                    choice: choice
                }));
            }

            // Disable choice buttons after a choice is made to prevent multiple clicks in the same round
            document.getElementById('choices').querySelectorAll('button').forEach(btn => btn.disabled = true);
        }

        // Update available players list
        function updateAvailablePlayers(players) {
            const availablePlayersList = document.getElementById('availablePlayers');
            availablePlayersList.innerHTML = ''; // Clear previous players

            if (Array.isArray(players) || players.length === 0)  {
                players.forEach(playerString => {
                    // Parse the player string into an object
                    let player;
                    try {
                        player = JSON.parse(playerString);
                    } catch (error) {
                        console.error("Error parsing player string:", playerString, error);
                        return;
                    }

                    // Ensure player object is valid
                    if (player && player.sessionId && player.username) {
                        // Exclude the current player by comparing sessionId
                        if (player.sessionId !== sessionId) {
                            const li = document.createElement('li');
                            li.textContent = player.username;

                            // Add an Invite button
                            const inviteButton = document.createElement('button');
                            inviteButton.textContent = 'Jouer contre';
                            inviteButton.onclick = () =>  { 
                                sendInvitation(player.username);
                            }
                            li.appendChild(inviteButton);
                            availablePlayersList.appendChild(li);
                        }
                    } else {
                        console.error('Invalid player object:', player);
                    }
                });

                if (availablePlayersList.innerHTML == '') {
                    document.getElementById('playersHeader').innerText = 'Liste des joueurs disponibles';
                }
    }
}

        function sendInvitation(opponent) {
            if (confirm(`Voulez-vous jouer contre ${opponent}?`)) {
                stompClient.send("/app/invite", {}, JSON.stringify({fromPlayer: username, toUsername: opponent}));
                stompClient.subscribe(`/user/${username}/queue/invitationAnswer`, function (message) {
                    if (message.body == 'confirmed') {
                        startGameForBothPlayers();
                    } else {
                        alert(opponent + " a refusé ton invitation.");
                    }
                });
            }
        }

        // Attach event listener to the "Connect" button
        document.getElementById('connectButton').addEventListener('click', connect);
    </script>
</body>
</html>
